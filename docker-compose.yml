# K-BAAS-2 Development Docker Compose Configuration
#
# This file extends the base configuration with development-specific settings:
# - Volume mounts for hot-reloading (code changes reflected immediately)
# - Development build targets in multi-stage Dockerfiles
# - Uses .env file for environment variables (not committed to git)
#
# Usage (via kbaas script):
#   ./kbaas dev           # Start dev environment with Authentik
#   ./kbaas dev --no-auth # Start dev environment without Authentik
#   ./kbaas down          # Stop services
#   ./kbaas reset         # Full reset (remove volumes, rebuild)
#
# NOTE: Authentik services are defined in docker-compose.authentik.yml
#       and loaded conditionally by the kbaas script

services:
  # ===================
  # APPLICATION SERVICES
  # ===================
  
  typedb:
    extends:
      file: docker-compose.base.yml
      service: typedb
    env_file:
      - .env
    networks:
      - kbaas-network

  backend:
    extends:
      file: docker-compose.base.yml
      service: backend
    build:
      context: ./backend
      target: development
    env_file:
      - .env
    environment:
      # Suppress uv hardlink warning when using volume mounts
      - UV_LINK_MODE=copy
    volumes:
      # Source mount for hot-reload (uvicorn --reload watches for changes)
      - ./backend:/app
      # Anonymous volumes to prevent host directories from overwriting container dependencies
      - /app/.venv
      - /app/__pycache__
    depends_on:
      typedb:
        condition: service_healthy
    networks:
      - kbaas-network

  frontend:
    extends:
      file: docker-compose.base.yml
      service: frontend
    build:
      context: ./frontend
      target: development
    env_file:
      - .env
    ports:
      - "${FRONTEND_PORT:-6166}:6166"
    volumes:
      # Source mount for hot-reload (Vite HMR watches for changes)
      - ./frontend:/app
      # Anonymous volume to prevent host node_modules from overwriting container dependencies
      - /app/node_modules
    networks:
      - kbaas-network

volumes:
  typedb-data: